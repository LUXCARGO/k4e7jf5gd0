<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - x7cargo</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f2f2f2; }
    header { background-color: #4CAF50; color: white; padding: 15px; text-align: center; font-size: 24px; }
    nav { display: flex; justify-content: center; background: #ddd; }
    nav button { background: none; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; }
    nav button.active { background: #fff; border-bottom: 3px solid #4CAF50; }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; background: white; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; }
    th { background-color: #f5f5f5; }
    tr:hover { background: #f0f8ff; }
    input, select, textarea { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    button.submit { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin-top: 10px; cursor: pointer; }
    .actions { display: flex; gap: 5px; }
  </style>
</head>
<body>

<header>üéØ –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å - x7cargo</header>

<nav>
  <button onclick="showScreen('trackScreen')" class="active">üì¶ –¢—Ä–µ–∫–∏</button>
  <button onclick="showScreen('usersScreen')">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
  <button onclick="showScreen('addScreen')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
</nav>

<!-- –¢—Ä–µ–∫–∏ -->
<section id="trackScreen" class="active">
  <h2>üì¶ –í—Å–µ —Ç—Ä–µ–∫-–∫–æ–¥—ã</h2>

  <label>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–∫-–∫–æ–¥—ã —Å –¥–∞—Ç–æ–π –ø—Ä–∏–±—ã—Ç–∏—è:</label>
  <input type="text" id="deleteDate" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 01.09.2025">
  <button class="submit" onclick="deleteTracksByDate()">–£–¥–∞–ª–∏—Ç—å –ø–æ –¥–∞—Ç–µ</button>

  <table>
    <thead>
      <tr>
        <th>–ö–æ–¥</th><th>–ì–æ—Ä–æ–¥</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="trackTable"></tbody>
  </table>
</section>

<!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
<section id="usersScreen">
  <h2>üë§ –ö–ª–∏–µ–Ω—Ç—ã</h2>
  <table>
    <thead>
      <tr>
        <th>–ò–º—è</th>
        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
        <th>–ê–¥—Ä–µ—Å</th>
        <th>user_id</th>
        <th>–ò–≤—É –∞–π–¥–∏</th>
        <th>–£—Ä—É–º—á–∏ –∞–π–¥–∏</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>
</section>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤ -->
<section id="addScreen">
  <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</h2>
  <form id="addForm">
    <label>–û–¥–∏–Ω–æ—á–Ω—ã–π —Ç—Ä–µ–∫-–∫–æ–¥:</label>
    <input type="text" id="code" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 12345678">
    <label>–ì–æ—Ä–æ–¥:</label>
    <input type="text" id="sity" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–≤—É">
    <label>–î–∞—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è:</label>
    <input type="text" id="arrival_date_warehouse" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 01.09.2025">
    <button type="submit" class="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  <hr>

  <h3>üì• –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫-–∫–æ–¥–æ–≤</h3>
  <textarea id="bulkTrackCodes" rows="10" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É —Ç—Ä–µ–∫-–∫–æ–¥—É –Ω–∞ —Å—Ç—Ä–æ–∫—É"></textarea>
  <label>–ì–æ—Ä–æ–¥:</label>
  <input type="text" id="bulkSity" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –ò–≤—É">
  <label>–î–∞—Ç–∞ –ø—Ä–∏–±—ã—Ç–∏—è:</label>
  <input type="text" id="bulkDate" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 01.09.2025">
  <button class="submit" onclick="addBulkTracks()">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Å–æ–≤–æ</button>
</section>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBX-ycZ5BsPuIiL7y3Mg936PsoBvMCCDD4",
    authDomain: "coociebook.firebaseapp.com",
    projectId: "coociebook",
    storageBucket: "coociebook.appspot.com",
    messagingSenderId: "51967296072",
    appId: "1:51967296072:web:0972dbfd6becb6a94a8e7d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function showScreen(id) {
    document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelector(`nav button[onclick*="${id}"]`).classList.add("active");
  }

  async function loadTrackData() {
    const tbody = document.getElementById("trackTable");
    tbody.innerHTML = "<tr><td colspan='4'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
    const tracks = await db.collection("trackcodecj").get();
    tbody.innerHTML = "";

    for (const doc of tracks.docs) {
      const t = doc.data();
      const row = `
        <tr>
          <td><input value="${t.code}" onchange="updateTrack('${doc.id}', 'code', this.value)" /></td>
          <td><input value="${t.sity}" onchange="updateTrack('${doc.id}', 'sity', this.value)" /></td>
          <td><input value="${t.arrival_date_warehouse}" onchange="updateTrack('${doc.id}', 'arrival_date_warehouse', this.value)" /></td>
          <td class="actions">
            <button onclick="deleteTrack('${doc.id}')">üóëÔ∏è</button>
          </td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', row);
    }
  }

  async function updateTrack(id, field, value) {
    await db.collection("trackcodecj").doc(id).update({ [field]: value });
  }

  async function deleteTrack(id) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—Ä–µ–∫-–∫–æ–¥?")) {
      await db.collection("trackcodecj").doc(id).delete();
      loadTrackData();
    }
  }

  async function deleteTracksByDate() {
    const date = document.getElementById("deleteDate").value.trim();
    if (!date) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É!");

    const snapshot = await db.collection("trackcodecj").where("arrival_date_warehouse", "==", date).get();
    if (snapshot.empty) return alert("–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤ —Å —ç—Ç–æ–π –¥–∞—Ç–æ–π.");

    if (confirm(`–£–¥–∞–ª–∏—Ç—å ${snapshot.size} —Ç—Ä–µ–∫–æ–≤ —Å –¥–∞—Ç–æ–π ${date}?`)) {
      const batch = db.batch();
      snapshot.docs.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      alert("‚úÖ –£–¥–∞–ª–µ–Ω–æ!");
      loadTrackData();
    }
  }

  async function loadUsers() {
    const tbody = document.getElementById("userTable");
    tbody.innerHTML = "<tr><td colspan='5'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
    const users = await db.collection("userscj").get();
    tbody.innerHTML = "";

    for (const doc of users.docs) {
      const u = doc.data();
      const row = `
        <tr>
          <td><input value="${u.name}" onchange="updateUser('${doc.id}', 'name', this.value)" /></td>
          <td><input value="${u.phone_number}" onchange="updateUser('${doc.id}', 'phone_number', this.value)" /></td>
          <td><input value="${u.delivery_address || ''}" onchange="updateUser('${doc.id}', 'delivery_address', this.value)" /></td>
          <td>${u.user_id}</td>
          <td>${u.iv_id}</td>
          <td>${u.urumqi_id}</td>
          <td><button onclick="deleteUser('${doc.id}')">üóëÔ∏è</button></td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', row);
    }
  }

  async function updateUser(id, field, value) {
    await db.collection("userscj").doc(id).update({ [field]: value });
  }

  async function deleteUser(id) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) {
      await db.collection("userscj").doc(id).delete();
      loadUsers();
    }
  }

  document.getElementById("addForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = {
      code: code.value.trim(),
      sity: sity.value.trim(),
      arrival_date_warehouse: arrival_date_warehouse.value.trim()
    };
    await db.collection("trackcodecj").add(data);
    alert("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ!");
    e.target.reset();
    showScreen('trackScreen');
    loadTrackData();
  });

  async function addBulkTracks() {
    const codesText = document.getElementById("bulkTrackCodes").value.trim();
    const sity = document.getElementById("bulkSity").value.trim();
    const arrivalDate = document.getElementById("bulkDate").value.trim();

    if (!codesText || !sity || !arrivalDate) {
      return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.");
    }

    const codes = codesText.split('\n').map(code => code.trim()).filter(code => code !== "");

    if (codes.length === 0) {
      return alert("–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç—Ä–µ–∫-–∫–æ–¥–æ–≤.");
    }

    const batch = db.batch();

    codes.forEach(code => {
      const docRef = db.collection("trackcodecj").doc();
      batch.set(docRef, {
        code: code,
        sity: sity,
        arrival_date_warehouse: arrivalDate
      });
    });

    try {
      await batch.commit();
      alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${codes.length} —Ç—Ä–µ–∫-–∫–æ–¥–æ–≤!`);
      document.getElementById("bulkTrackCodes").value = "";
      loadTrackData();
      showScreen("trackScreen");
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏:", error);
      alert("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.");
    }
  }

  // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  loadTrackData();
  loadUsers();
</script>

</body>
</html>
